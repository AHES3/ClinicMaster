<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî ClinicMaster</title>
    <meta name="description" content="ClinicMaster Dashboard ‚Äî Overview of patients, drugs, appointments, and files.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&family=DM+Sans:wght@200;300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- Cursor -->
    <div id="cd"></div>
    <div id="cr"></div>
    <!-- Letterbox -->
    <div id="lbt"></div>
    <div id="lbb"></div>
    <!-- FX -->
    <div class="grain"></div>
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <!-- Toast -->
    <div id="toast"><span class="tdot"></span><span id="tmsg">Done</span></div>

    <!-- Mobile Toggle -->
    <button class="sb-toggle" onclick="document.querySelector('.sb').classList.toggle('open')">‚ò∞</button>

    <div class="app-shell">
        <!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
        <aside class="sb">
            <div class="sbb"><a href="index.html" style="text-decoration:none;color:inherit">Clinic<em>Master</em></a>
            </div>
            <div class="sbn">
                <div class="sb-section-label">Main</div>
                <a href="dashboard.html" class="ni" data-page="dashboard">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                    </svg>
                    Overview
                </a>
                <a href="patients.html" class="ni" data-page="patients">
                    <svg viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                    Patients
                </a>
                <a href="add-patient.html" class="ni" data-page="add-patient">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="16" />
                        <line x1="8" y1="12" x2="16" y2="12" />
                    </svg>
                    New Patient
                </a>

                <div class="sb-section-label">Clinical</div>
                <a href="pharmacy.html" class="ni" data-page="pharmacy">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
                    </svg>
                    Pharmacy
                </a>
                <a href="diagnoses.html" class="ni" data-page="diagnoses">
                    <svg viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg>
                    Diagnoses
                </a>
                <a href="appointments.html" class="ni" data-page="appointments">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                    Appointments
                </a>
                <a href="files.html" class="ni" data-page="files">
                    <svg viewBox="0 0 24 24">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                    </svg>
                    Files
                </a>
            </div>
            <div class="dbs">
                <div class="dd dd-indicator" id="dd2"></div>
                <span class="ds-text" id="ds2">Connecting‚Ä¶</span>
            </div>
            <div class="sbbot">
                <div class="uch">
                    <div class="uav">Dr</div>
                    <div>
                        <div class="unm">Dr. Admin</div>
                        <div class="url2">Physician</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê -->
        <main class="main-content panel-animate">

            <!-- Supabase Banner -->
            <div class="cfg-banner" style="display:flex;align-items:center;gap:12px;padding:14px 20px">
                <div class="dd dd-indicator on" id="dd1"></div>
                <span style="font-size:12px;color:var(--font-primary);font-weight:400">Supabase ‚Äî Live</span>
                <span style="font-size:11px;color:var(--font-secondary)">¬∑</span>
                <code>pxbfwesywdbxiibxgmwe.supabase.co</code>
                <span style="font-size:11px;color:var(--font-secondary)">¬∑ RLS Enabled</span>
            </div>

            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <div class="page-title">Dashboard <em>Overview</em></div>
                    <div class="page-subtitle">Real-time clinic metrics and recent activity</div>
                </div>
                <div class="page-actions">
                    <button class="bs" onclick="loadDashboard()">‚Üª Refresh</button>
                    <a href="add-patient.html"><button class="bs sol">+ New Patient</button></a>
                </div>
            </div>

            <!-- Metrics -->
            <div class="mets">
                <div class="mc">
                    <div class="mc-icon">üë§</div>
                    <div class="mn" id="m-p">‚Äî</div>
                    <div class="ml">Total Patients</div>
                </div>
                <div class="mc">
                    <div class="mc-icon">üíä</div>
                    <div class="mn" id="m-d">‚Äî</div>
                    <div class="ml">Drug Records</div>
                </div>
                <div class="mc">
                    <div class="mc-icon">üìÖ</div>
                    <div class="mn" id="m-a">‚Äî</div>
                    <div class="ml">Appointments</div>
                </div>
                <div class="mc">
                    <div class="mc-icon">üìÅ</div>
                    <div class="mn" id="m-f">‚Äî</div>
                    <div class="ml">Files Stored</div>
                </div>
            </div>

            <!-- Recent Patients -->
            <div class="section-divider">
                <div class="sl">Recent Patients</div>
            </div>
            <div class="tw">
                <table>
                    <thead>
                        <tr>
                            <th>Patient ID</th>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Blood</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="ov-tb">
                        <tr>
                            <td colspan="6" style="text-align:center;padding:24px;color:var(--font-secondary)">Loading‚Ä¶
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Recent Appointments -->
            <div class="section-divider">
                <div class="sl">Upcoming Appointments</div>
            </div>
            <div class="tw">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Patient</th>
                            <th>Physician</th>
                            <th>Reason</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="ov-apt">
                        <tr>
                            <td colspan="5" style="text-align:center;padding:24px;color:var(--font-secondary)">Loading‚Ä¶
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </main>
    </div>

    <!-- Patient Detail Modal -->
    <div class="mo" id="pdm">
        <div class="md">
            <button class="mdc" onclick="closeModal('pdm')">‚úï</button>
            <div class="mdt" id="pd-t">Patient</div>
            <div id="pd-b"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/app.js"></script>
    <script>
        async function loadDashboard() {
            await loadAll();
            renderMetrics();
            renderRecentPatients();
            renderUpcomingAppointments();
        }

        function renderMetrics() {
            document.getElementById('m-p').textContent = DB.patients.length;
            document.getElementById('m-d').textContent = DB.drugs.length;
            document.getElementById('m-a').textContent = DB.appointments.length;
            document.getElementById('m-f').textContent = DB.files.length;
        }

        function renderRecentPatients() {
            const tb = document.getElementById('ov-tb');
            const rec = DB.patients.slice(0, 8);
            if (!rec.length) {
                tb.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:28px;color:var(--font-secondary)">No patients registered yet. <a href="add-patient.html" style="color:var(--accent-blue)">Add your first patient ‚Üí</a></td></tr>';
                return;
            }
            tb.innerHTML = rec.map(p => `<tr>
    <td style="color:var(--accent-blue);font-family:var(--serif)">${p.id}</td>
    <td style="color:var(--font-primary);font-weight:400">${p.name}</td>
    <td>${p.age || '‚Äî'}</td><td>${p.blood || '‚Äî'}</td>
    <td><span class="badge ba">${p.status || 'active'}</span></td>
    <td><button class="bs" onclick="viewPatient('${p.id}')">View</button></td>
  </tr>`).join('');
        }

        function renderUpcomingAppointments() {
            const tb = document.getElementById('ov-apt');
            const upcoming = DB.appointments.filter(a => a.status !== 'completed').slice(0, 5);
            if (!upcoming.length) {
                tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:28px;color:var(--font-secondary)">No upcoming appointments. <a href="appointments.html" style="color:var(--accent-blue)">Schedule one ‚Üí</a></td></tr>';
                return;
            }
            tb.innerHTML = upcoming.map(a => `<tr>
    <td style="color:var(--font-primary)">${fmtDateTime(a.datetime)}</td>
    <td>${a.patient_name}</td><td>${a.doctor || '‚Äî'}</td><td>${a.reason || '‚Äî'}</td>
    <td><span class="badge ${a.status === 'completed' ? 'ba' : 'bp'}">${a.status}</span></td>
  </tr>`).join('');
        }

        function viewPatient(id) {
            const p = DB.patients.find(x => x.id === id);
            if (!p) return;
            document.getElementById('pd-t').textContent = p.name;
            document.getElementById('pd-b').innerHTML = `
    <div class="pidb"><div class="pidl">Patient ID</div><div class="pidn">${p.id}</div></div>
    <div class="fgg" style="font-size:12.5px;color:var(--font-secondary);margin-top:16px">
      <div><div class="al" style="margin-bottom:4px">Phone</div>${p.phone || '‚Äî'}</div>
      <div><div class="al" style="margin-bottom:4px">Email</div>${p.email || '‚Äî'}</div>
      <div><div class="al" style="margin-bottom:4px">Date of Birth</div>${p.dob || '‚Äî'}</div>
      <div><div class="al" style="margin-bottom:4px">Blood Type</div>${p.blood || '‚Äî'}</div>
      <div><div class="al" style="margin-bottom:4px">Insurance</div>${p.insurance || '‚Äî'}</div>
      <div><div class="al" style="margin-bottom:4px">Age</div>${p.age || '‚Äî'}</div>
    </div>
    ${p.address ? `<div style="margin-top:14px;font-size:12.5px;color:var(--font-secondary)"><div class="al" style="margin-bottom:4px">Address</div>${p.address}</div>` : ''}
    ${p.notes ? `<div style="margin-top:14px;font-size:12.5px;color:var(--font-secondary)"><div class="al" style="margin-bottom:4px">Medical Notes</div>${p.notes}</div>` : ''}
    <div style="margin-top:20px;display:flex;gap:8px">
      <a href="files.html?patient=${p.id}"><button class="bs blue">View Files</button></a>
      <a href="diagnoses.html?patient=${p.id}"><button class="bs">Diagnoses</button></a>
    </div>`;
            openModal('pdm');
        }

        loadDashboard();
    </script>
</body>

</html>