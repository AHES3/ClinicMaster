<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Archive â€” ClinicMaster</title>
    <meta name="description" content="Upload and manage patient files in ClinicMaster.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&family=DM+Sans:wght@200;300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <div id="cd"></div>
    <div id="cr"></div>
    <div id="lbt"></div>
    <div id="lbb"></div>
    <div class="grain"></div>
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div id="toast"><span class="tdot"></span><span id="tmsg">Done</span></div>

    <button class="sb-toggle" onclick="document.querySelector('.sb').classList.toggle('open')">â˜°</button>

    <div class="app-shell">
        <!-- â•â•â• SIDEBAR â•â•â• -->
        <aside class="sb">
            <div class="sbb"><a href="index.html" style="text-decoration:none;color:inherit">Clinic<em>Master</em></a>
            </div>
            <div class="sbn">
                <div class="sb-section-label">Main</div>
                <a href="dashboard.html" class="ni" data-page="dashboard">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                    </svg>Overview</a>
                <a href="patients.html" class="ni" data-page="patients">
                    <svg viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>Patients</a>
                <a href="add-patient.html" class="ni" data-page="add-patient">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="16" />
                        <line x1="8" y1="12" x2="16" y2="12" />
                    </svg>New Patient</a>
                <div class="sb-section-label">Clinical</div>
                <a href="pharmacy.html" class="ni" data-page="pharmacy">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
                    </svg>Pharmacy</a>
                <a href="diagnoses.html" class="ni" data-page="diagnoses">
                    <svg viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg>Diagnoses</a>
                <a href="appointments.html" class="ni" data-page="appointments">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>Appointments</a>
                <a href="files.html" class="ni" data-page="files">
                    <svg viewBox="0 0 24 24">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                    </svg>Files</a>
            </div>
            <div class="dbs">
                <div class="dd dd-indicator"></div><span class="ds-text">Connectingâ€¦</span>
            </div>
            <div class="sbbot">
                <div class="uch">
                    <div class="uav">Dr</div>
                    <div>
                        <div class="unm">Dr. Admin</div>
                        <div class="url2">Physician</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- â•â•â• MAIN â•â•â• -->
        <main class="main-content panel-animate">
            <div class="page-header">
                <div>
                    <div class="page-title">File <em>Archive</em></div>
                    <div class="page-subtitle">Upload and manage patient files â€” every file must be linked to a patient
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <div style="max-width: 700px; margin-bottom: 32px;">
                <div class="ig">
                    <label>Select Patient *</label>
                    <select id="fp-sel" class="patient-select" onchange="checkPatientSelected()">
                        <option value="">â€” Select a patient first â€”</option>
                    </select>
                    <p id="fp-hint" style="font-size:11px;color:#d97706;margin-top:6px;display:none">
                        âš  You must select a patient before uploading files. Files are always linked to a specific
                        patient record.
                    </p>
                </div>

                <div class="uz" id="uzn" onclick="triggerUpload()" style="opacity: 0.5; pointer-events: none;">
                    <input type="file" id="fi" multiple onchange="handleFiles(this.files)">
                    <div class="ui">â¬†</div>
                    <div class="ut">Drop files or click to upload</div>
                    <div class="us">PDF, DOCX, images, DICOM, lab results â€” all types supported</div>
                </div>
                <div class="fl" id="fl"></div>
            </div>

            <!-- Filter by patient -->
            <div class="section-divider">
                <div class="sl">Stored Files</div>
            </div>

            <div class="sbar2">
                <input id="fsrch" placeholder="Filter by filename or patient nameâ€¦" oninput="filterFiles()">
                <select id="ffilter" onchange="filterFiles()"
                    style="width:240px;background:var(--surface);border:1.5px solid var(--border);color:var(--font-primary);padding:10px 14px;font-family:var(--sans);font-size:13px;outline:none;border-radius:var(--rs);">
                    <option value="">All Patients</option>
                </select>
            </div>

            <div class="tw">
                <table>
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Patient</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Date</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="f-tb">
                        <tr>
                            <td colspan="6" style="text-align:center;padding:28px;color:var(--font-secondary)">Loadingâ€¦
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/app.js"></script>
    <script>
        async function loadPage() {
            await loadAll();
            populatePatientSelects();
            populatePatientFilter();
            renderFiles();

            // Pre-select patient from URL
            const params = new URLSearchParams(window.location.search);
            const pid = params.get('patient');
            if (pid) {
                document.getElementById('fp-sel').value = pid;
                document.getElementById('ffilter').value = pid;
                checkPatientSelected();
                filterFiles();
            }

            // Init drag/drop
            const uz = document.getElementById('uzn');
            uz.addEventListener('dragover', e => {
                e.preventDefault();
                if (!document.getElementById('fp-sel').value) return;
                uz.classList.add('dg');
            });
            uz.addEventListener('dragleave', () => uz.classList.remove('dg'));
            uz.addEventListener('drop', e => {
                e.preventDefault();
                uz.classList.remove('dg');
                if (!document.getElementById('fp-sel').value) {
                    toast('Select a patient first!', 'err');
                    return;
                }
                handleFiles(e.dataTransfer.files);
            });
        }

        function checkPatientSelected() {
            const selected = document.getElementById('fp-sel').value;
            const uz = document.getElementById('uzn');
            const hint = document.getElementById('fp-hint');

            if (selected) {
                uz.style.opacity = '1';
                uz.style.pointerEvents = 'auto';
                hint.style.display = 'none';
            } else {
                uz.style.opacity = '0.5';
                uz.style.pointerEvents = 'none';
                hint.style.display = 'block';
            }
        }

        function triggerUpload() {
            if (!document.getElementById('fp-sel').value) {
                toast('Please select a patient before uploading files', 'err');
                return;
            }
            document.getElementById('fi').click();
        }

        function populatePatientFilter() {
            const sel = document.getElementById('ffilter');
            const opts = DB.patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            sel.innerHTML = '<option value="">All Patients</option>' + opts;
        }

        async function handleFiles(files) {
            const pid = document.getElementById('fp-sel').value;
            if (!pid) {
                toast('Select a patient first!', 'err');
                return;
            }

            const pat = DB.patients.find(p => p.id === pid);
            if (!pat) {
                toast('Patient not found', 'err');
                return;
            }

            for (const file of Array.from(files)) {
                const row = {
                    id: 'FILE-' + Date.now() + Math.floor(Math.random() * 9999),
                    name: file.name, size: file.size, type: file.type,
                    patient_id: pid, patient_name: pat.name,
                    date: new Date().toISOString()
                };
                if (await ins('cm_files', row)) {
                    DB.files.unshift(row);
                    const el = document.createElement('div');
                    el.className = 'fit';
                    el.innerHTML = `<span class="fn2">ðŸ“„ ${file.name}</span><span class="fm">${fmtSize(file.size)} Â· ${pat.name}</span>`;
                    document.getElementById('fl').prepend(el);
                    toast('Uploaded: ' + file.name + ' â†’ ' + pat.name, 'ok');
                }
            }
            renderFiles();
        }

        function renderFiles() {
            const tb = document.getElementById('f-tb');
            const searchQ = (document.getElementById('fsrch')?.value || '').toLowerCase();
            const patientFilter = document.getElementById('ffilter')?.value || '';

            let items = DB.files;
            if (patientFilter) items = items.filter(f => f.patient_id === patientFilter);
            if (searchQ) items = items.filter(f =>
                f.name.toLowerCase().includes(searchQ) ||
                (f.patient_name && f.patient_name.toLowerCase().includes(searchQ))
            );

            if (!items.length) {
                tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:32px;color:var(--font-secondary)">
      ${searchQ || patientFilter ? 'No files match your filter.' : 'No files uploaded yet. Select a patient and upload files above.'}
    </td></tr>`;
                return;
            }

            tb.innerHTML = items.map(f => {
                const icon = getFileIcon(f.type || f.name);
                return `<tr>
      <td style="color:var(--font-primary)">${icon} ${f.name}</td>
      <td>
        <span style="color:var(--accent-blue);font-size:11px">${f.patient_name || 'â€”'}</span>
      </td>
      <td style="font-size:11px">${getFileType(f.type || f.name)}</td>
      <td>${fmtSize(f.size)}</td>
      <td>${fmtDate(f.date)}</td>
      <td><button class="bs dng" onclick="deleteFile('${f.id}')">Remove</button></td>
    </tr>`;
            }).join('');
        }

        function filterFiles() { renderFiles(); }

        function getFileIcon(type) {
            if (!type) return 'ðŸ“„';
            if (type.includes('image')) return 'ðŸ–¼ï¸';
            if (type.includes('pdf')) return 'ðŸ“•';
            if (type.includes('word') || type.includes('doc')) return 'ðŸ“˜';
            if (type.includes('spreadsheet') || type.includes('excel') || type.includes('csv')) return 'ðŸ“—';
            if (type.includes('dicom')) return 'ðŸ©»';
            return 'ðŸ“„';
        }

        function getFileType(type) {
            if (!type) return 'â€”';
            if (type.includes('image')) return 'Image';
            if (type.includes('pdf')) return 'PDF';
            if (type.includes('word') || type.includes('doc')) return 'Document';
            if (type.includes('spreadsheet') || type.includes('excel')) return 'Spreadsheet';
            if (type.includes('csv')) return 'CSV';
            if (type.includes('dicom')) return 'DICOM';
            return type.split('/').pop() || 'â€”';
        }

        async function deleteFile(id) {
            if (!confirm('Remove this file record?')) return;
            await del('cm_files', id);
            DB.files = DB.files.filter(f => f.id !== id);
            renderFiles();
            toast('File removed');
        }

        loadPage();
    </script>
</body>

</html>