<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments ‚Äî ClinicMaster</title>
    <meta name="description" content="Schedule and manage patient appointments in ClinicMaster.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&family=DM+Sans:wght@200;300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <div id="cd"></div>
    <div id="cr"></div>
    <div id="lbt"></div>
    <div id="lbb"></div>
    <div class="grain"></div>
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div id="toast"><span class="tdot"></span><span id="tmsg">Done</span></div>

    <button class="sb-toggle" onclick="document.querySelector('.sb').classList.toggle('open')">‚ò∞</button>

    <div class="app-shell">
        <!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
        <aside class="sb">
            <div class="sbb"><a href="index.html" style="text-decoration:none;color:inherit">Clinic<em>Master</em></a>
            </div>
            <div class="sbn">
                <div class="sb-section-label">Main</div>
                <a href="dashboard.html" class="ni" data-page="dashboard">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                    </svg>Overview</a>
                <a href="patients.html" class="ni" data-page="patients">
                    <svg viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>Patients</a>
                <a href="add-patient.html" class="ni" data-page="add-patient">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="16" />
                        <line x1="8" y1="12" x2="16" y2="12" />
                    </svg>New Patient</a>
                <div class="sb-section-label">Clinical</div>
                <a href="pharmacy.html" class="ni" data-page="pharmacy">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
                    </svg>Pharmacy</a>
                <a href="diagnoses.html" class="ni" data-page="diagnoses">
                    <svg viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg>Diagnoses</a>
                <a href="appointments.html" class="ni" data-page="appointments">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>Appointments</a>
                <a href="files.html" class="ni" data-page="files">
                    <svg viewBox="0 0 24 24">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                    </svg>Files</a>
            </div>
            <div class="dbs">
                <div class="dd dd-indicator"></div><span class="ds-text">Connecting‚Ä¶</span>
            </div>
            <div class="sbbot">
                <div class="uch">
                    <div class="uav">Dr</div>
                    <div>
                        <div class="unm">Dr. Admin</div>
                        <div class="url2">Physician</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
        <main class="main-content panel-animate">
            <div class="page-header">
                <div>
                    <div class="page-title"><em>Appointments</em></div>
                    <div class="page-subtitle">Schedule, track, and manage patient appointments</div>
                </div>
                <div class="page-actions">
                    <button class="bs sol" onclick="openScheduleModal()">+ Schedule</button>
                </div>
            </div>

            <!-- Tabs for filtering -->
            <div class="tabs">
                <button class="tab-btn active" onclick="setFilter('all', this)">All</button>
                <button class="tab-btn" onclick="setFilter('scheduled', this)">Scheduled</button>
                <button class="tab-btn" onclick="setFilter('completed', this)">Completed</button>
                <button class="tab-btn" onclick="setFilter('cancelled', this)">Cancelled</button>
            </div>

            <!-- Metrics -->
            <div class="mets" style="margin-bottom:24px">
                <div class="mc">
                    <div class="mc-icon">üìÖ</div>
                    <div class="mn" id="m-total">‚Äî</div>
                    <div class="ml">Total</div>
                </div>
                <div class="mc">
                    <div class="mc-icon">‚è≥</div>
                    <div class="mn" id="m-sched">‚Äî</div>
                    <div class="ml">Scheduled</div>
                </div>
                <div class="mc">
                    <div class="mc-icon">‚úì</div>
                    <div class="mn" id="m-done">‚Äî</div>
                    <div class="ml">Completed</div>
                </div>
            </div>

            <div class="tw">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Patient</th>
                            <th>Physician</th>
                            <th>Reason</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="a-tb">
                        <tr>
                            <td colspan="7" style="text-align:center;padding:28px;color:var(--font-secondary)">Loading‚Ä¶
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Schedule Appointment Modal -->
    <div class="mo" id="am">
        <div class="md">
            <button class="mdc" onclick="closeModal('am')">‚úï</button>
            <div class="mdt">Schedule Appointment</div>
            <div class="fgg">
                <div class="ig">
                    <label>Patient *</label>
                    <select id="ap-p" class="patient-select">
                        <option value="">Select patient‚Ä¶</option>
                    </select>
                </div>
                <div class="ig"><label>Physician</label><input id="ap-d" placeholder="Dr. Name"></div>
            </div>
            <div class="fgg">
                <div class="ig"><label>Date & Time *</label><input type="datetime-local" id="ap-dt"></div>
                <div class="ig"><label>Duration (min)</label><input type="number" id="ap-dur" value="30"></div>
            </div>
            <div class="ig"><label>Reason for Visit</label><input id="ap-r" placeholder="Annual checkup, Follow-up‚Ä¶">
            </div>
            <div class="ig"><label>Notes</label><textarea id="ap-n" placeholder="Additional notes‚Ä¶"></textarea></div>
            <button class="bs sol" onclick="saveAppointment()">Confirm Appointment</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/app.js"></script>
    <script>
        let currentFilter = 'all';

        async function loadPage() {
            await loadAll();
            populatePatientSelects();
            renderAppointments();
            renderMetrics();
        }

        function setFilter(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderAppointments();
        }

        function renderMetrics() {
            document.getElementById('m-total').textContent = DB.appointments.length;
            document.getElementById('m-sched').textContent = DB.appointments.filter(a => a.status === 'scheduled').length;
            document.getElementById('m-done').textContent = DB.appointments.filter(a => a.status === 'completed').length;
        }

        function renderAppointments() {
            const tb = document.getElementById('a-tb');
            let items = DB.appointments;
            if (currentFilter !== 'all') items = items.filter(a => a.status === currentFilter);

            if (!items.length) {
                tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--font-secondary)">
      ${currentFilter === 'all' ? 'No appointments yet. Click "+ Schedule" to create one.' : 'No ' + currentFilter + ' appointments.'}
    </td></tr>`;
                return;
            }

            tb.innerHTML = items.map(a => {
                const isPast = new Date(a.datetime) < new Date() && a.status === 'scheduled';
                return `<tr>
      <td style="color:var(--font-primary)">${fmtDateTime(a.datetime)}</td>
      <td>${a.patient_name || '‚Äî'}</td>
      <td>${a.doctor || '‚Äî'}</td>
      <td>${a.reason || '‚Äî'}</td>
      <td>${a.duration || 30} min</td>
      <td>
        <span class="badge ${a.status === 'completed' ? 'ba' : a.status === 'cancelled' ? 'bc' : isPast ? 'bp' : 'bb'}">
          ${isPast ? 'overdue' : a.status}
        </span>
      </td>
      <td style="display:flex;gap:6px">
        ${a.status === 'scheduled' ? `<button class="bs blue" onclick="completeAppointment('${a.id}')">‚úì Done</button>` : ''}
        ${a.status === 'scheduled' ? `<button class="bs" onclick="cancelAppointment('${a.id}')">Cancel</button>` : ''}
        <button class="bs dng" onclick="deleteAppointment('${a.id}')">‚úï</button>
      </td>
    </tr>`;
            }).join('');
        }

        function openScheduleModal() {
            populatePatientSelects();
            openModal('am');
        }

        async function saveAppointment() {
            const dt = document.getElementById('ap-dt').value;
            if (!dt) { toast('Select date and time', 'err'); return; }
            const pid = document.getElementById('ap-p').value;
            const pat = DB.patients.find(p => p.id === pid);

            const row = {
                id: 'APT-' + Date.now(),
                patient_id: pid || null, patient_name: pat?.name || 'Walk-in',
                doctor: document.getElementById('ap-d').value,
                datetime: new Date(dt).toISOString(),
                duration: parseInt(document.getElementById('ap-dur').value) || 30,
                reason: document.getElementById('ap-r').value,
                notes: document.getElementById('ap-n').value,
                status: 'scheduled',
                created: new Date().toISOString()
            };

            if (!await ins('cm_appointments', row)) return;
            DB.appointments.unshift(row);
            closeModal('am');
            renderAppointments();
            renderMetrics();
            toast('Appointment scheduled', 'ok');

            // Clear form
            ['ap-d', 'ap-r', 'ap-n'].forEach(f => document.getElementById(f).value = '');
            document.getElementById('ap-dt').value = '';
            document.getElementById('ap-dur').value = '30';
        }

        async function completeAppointment(id) {
            await upd('cm_appointments', id, { status: 'completed' });
            const a = DB.appointments.find(x => x.id === id);
            if (a) a.status = 'completed';
            renderAppointments();
            renderMetrics();
            toast('Appointment completed', 'ok');
        }

        async function cancelAppointment(id) {
            if (!confirm('Cancel this appointment?')) return;
            await upd('cm_appointments', id, { status: 'cancelled' });
            const a = DB.appointments.find(x => x.id === id);
            if (a) a.status = 'cancelled';
            renderAppointments();
            renderMetrics();
            toast('Appointment cancelled');
        }

        async function deleteAppointment(id) {
            if (!confirm('Delete this appointment permanently?')) return;
            await del('cm_appointments', id);
            DB.appointments = DB.appointments.filter(a => a.id !== id);
            renderAppointments();
            renderMetrics();
            toast('Appointment deleted');
        }

        loadPage();
    </script>
</body>

</html>