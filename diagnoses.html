<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Reports — ClinicMaster</title>
    <meta name="description" content="Generate AI medical reports and manage patient diagnoses in ClinicMaster.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&family=DM+Sans:wght@200;300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <div id="cd"></div>
    <div id="cr"></div>
    <div id="lbt"></div>
    <div id="lbb"></div>
    <div class="grain"></div>
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div id="toast"><span class="tdot"></span><span id="tmsg">Done</span></div>

    <button class="sb-toggle" onclick="document.querySelector('.sb').classList.toggle('open')">☰</button>

    <div class="app-shell">
        <!-- ═══ SIDEBAR ═══ -->
        <aside class="sb">
            <div class="sbb"><a href="index.html" style="text-decoration:none;color:inherit">Clinic<em>Master</em></a>
            </div>
            <div class="sbn">
                <div class="sb-section-label">Main</div>
                <a href="dashboard.html" class="ni" data-page="dashboard">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                    </svg>Overview</a>
                <a href="patients.html" class="ni" data-page="patients">
                    <svg viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>Patients</a>
                <a href="add-patient.html" class="ni" data-page="add-patient">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="16" />
                        <line x1="8" y1="12" x2="16" y2="12" />
                    </svg>New Patient</a>
                <div class="sb-section-label">Clinical</div>
                <a href="pharmacy.html" class="ni" data-page="pharmacy">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
                    </svg>Pharmacy</a>
                <a href="diagnoses.html" class="ni" data-page="diagnoses">
                    <svg viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg>Diagnoses</a>
                <a href="appointments.html" class="ni" data-page="appointments">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>Appointments</a>
                <a href="files.html" class="ni" data-page="files">
                    <svg viewBox="0 0 24 24">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                    </svg>Files</a>
            </div>
            <div class="dbs">
                <div class="dd dd-indicator"></div><span class="ds-text">Connecting…</span>
            </div>
            <div class="sbbot">
                <div class="uch">
                    <div class="uav">Dr</div>
                    <div>
                        <div class="unm">Dr. Admin</div>
                        <div class="url2">Physician</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ═══ MAIN ═══ -->
        <main class="main-content panel-animate">
            <div class="page-header">
                <div>
                    <div class="page-title">Medical <em>Reports</em></div>
                    <div class="page-subtitle">Enter diagnosis details and generate AI clinical reports</div>
                </div>
            </div>

            <!-- Diagnosis Form -->
            <div style="max-width: 800px;">
                <div class="fgg">
                    <div class="ig">
                        <label>Patient *</label>
                        <select id="dx-p" class="patient-select">
                            <option value="">Select patient…</option>
                        </select>
                    </div>
                    <div class="ig"><label>Attending Physician</label><input id="dx-doc" placeholder="Dr. Name"></div>
                </div>
                <div class="ig">
                    <label>Diagnosis / Chief Complaint *</label>
                    <textarea id="dx-t" placeholder="Patient presents with…" style="min-height:80px"></textarea>
                </div>
                <div class="fgg">
                    <div class="ig">
                        <label>Prescribed Medications</label>
                        <textarea id="dx-m" placeholder="Medication list…" style="min-height:70px"></textarea>
                    </div>
                    <div class="ig">
                        <label>Lab / Test Orders</label>
                        <textarea id="dx-l" placeholder="CBC, Metabolic panel…" style="min-height:70px"></textarea>
                    </div>
                </div>
                <div style="display:flex;gap:10px">
                    <button class="bs sol" onclick="genReport()">Generate AI Report</button>
                    <button class="bs blue" onclick="saveDiagnosis()">Save Diagnosis</button>
                </div>

                <!-- AI Report Output -->
                <div id="rw" style="display:none;margin-top:20px">
                    <div class="al">AI-Generated Medical Report</div>
                    <div class="ao" id="rt"></div>
                    <div style="display:flex;gap:8px;margin-top:12px">
                        <button class="bs sol" onclick="printReport()">Print / Export</button>
                        <button class="bs blue" onclick="saveReport()">Save Report</button>
                    </div>
                </div>
            </div>

            <!-- Saved Diagnoses -->
            <div class="section-divider">
                <div class="sl">Saved Diagnoses</div>
            </div>
            <div class="tw">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Physician</th>
                            <th>Diagnosis</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="dx-tb">
                        <tr>
                            <td colspan="5" style="text-align:center;padding:24px;color:var(--font-secondary)">Loading…
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Diagnosis Detail Modal -->
    <div class="mo" id="dxdm">
        <div class="md">
            <button class="mdc" onclick="closeModal('dxdm')">✕</button>
            <div class="mdt" id="dxd-title">Diagnosis</div>
            <div id="dxd-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/app.js"></script>
    <script>
        async function loadPage() {
            await loadAll();
            populatePatientSelects();
            renderDiagnoses();

            // Pre-select patient from URL
            const params = new URLSearchParams(window.location.search);
            const pid = params.get('patient');
            if (pid) document.getElementById('dx-p').value = pid;
        }

        function renderDiagnoses() {
            const tb = document.getElementById('dx-tb');
            if (!DB.diagnoses.length) {
                tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:28px;color:var(--font-secondary)">No diagnoses saved yet</td></tr>';
                return;
            }
            tb.innerHTML = DB.diagnoses.map(d => `<tr>
    <td>${fmtDate(d.date)}</td>
    <td style="color:var(--font-primary)">${d.patient_name || '—'}</td>
    <td>${d.doctor || '—'}</td>
    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.diagnosis || d.type || '—'}</td>
    <td style="display:flex;gap:6px">
      <button class="bs" onclick="viewDx('${d.id}')">View</button>
      <button class="bs dng" onclick="delDx('${d.id}')">Del</button>
    </td>
  </tr>`).join('');
        }

        function viewDx(id) {
            const d = DB.diagnoses.find(x => x.id === id);
            if (!d) return;
            document.getElementById('dxd-title').textContent = d.patient_name || 'Diagnosis';
            document.getElementById('dxd-body').innerHTML = `
    <div class="patient-meta" style="margin-bottom:16px">
      <div class="patient-meta-item"><div class="meta-label">Date</div><div class="meta-value">${fmtDate(d.date)}</div></div>
      <div class="patient-meta-item"><div class="meta-label">Physician</div><div class="meta-value">${d.doctor || '—'}</div></div>
      <div class="patient-meta-item"><div class="meta-label">Patient</div><div class="meta-value">${d.patient_name || '—'}</div></div>
    </div>
    ${d.diagnosis ? `<div style="margin-bottom:12px"><div class="al" style="margin-bottom:4px">Diagnosis</div><div style="font-size:12.5px;color:var(--font-secondary);line-height:1.8">${d.diagnosis}</div></div>` : ''}
    ${d.meds ? `<div style="margin-bottom:12px"><div class="al" style="margin-bottom:4px">Medications</div><div style="font-size:12.5px;color:var(--font-secondary)">${d.meds}</div></div>` : ''}
    ${d.labs ? `<div style="margin-bottom:12px"><div class="al" style="margin-bottom:4px">Lab Orders</div><div style="font-size:12.5px;color:var(--font-secondary)">${d.labs}</div></div>` : ''}
    ${d.report ? `<div><div class="al" style="margin-bottom:4px">AI Report</div><div class="ao">${d.report}</div></div>` : ''}`;
            openModal('dxdm');
        }

        async function genReport() {
            const pid = document.getElementById('dx-p').value;
            const diag = document.getElementById('dx-t').value.trim();
            if (!diag) { toast('Enter diagnosis', 'err'); return; }

            const pat = DB.patients.find(p => p.id === pid);
            const w = document.getElementById('rw');
            const t = document.getElementById('rt');
            w.style.display = 'block';
            t.className = 'ao ld';
            t.textContent = 'Generating clinical report…';

            try {
                const r = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514', max_tokens: 1000,
                        messages: [{ role: 'user', content: `Generate a formal clinical medical report.\nPatient: ${pat?.name || 'Unknown'} (ID: ${pid || 'N/A'})\nPhysician: ${document.getElementById('dx-doc').value || 'Not specified'}\nDate: ${new Date().toLocaleDateString()}\nDiagnosis: ${diag}\nMedications: ${document.getElementById('dx-m').value || 'None'}\nOrders: ${document.getElementById('dx-l').value || 'None'}\n\nWrite a formal clinical report: Patient Summary, Assessment, Impression, Treatment Plan, Follow-up recommendations.` }]
                    })
                });
                const data = await r.json();
                t.className = 'ao';
                t.textContent = data.content?.[0]?.text || 'Failed.';
            } catch {
                t.className = 'ao';
                t.textContent = `CLINICAL REPORT — ${new Date().toLocaleDateString()}\n\nPATIENT: ${pat?.name || 'N/A'} (${pid || 'N/A'})\nPHYSICIAN: ${document.getElementById('dx-doc').value || 'Dr. Admin'}\n\nASSESSMENT:\n${diag}\n\nPLAN:\nMedications: ${document.getElementById('dx-m').value || 'None'}\nOrders: ${document.getElementById('dx-l').value || 'None'}\n\nFOLLOW-UP:\nReturn in 2 weeks or sooner if symptoms worsen.`;
            }
        }

        async function saveDiagnosis() {
            const diag = document.getElementById('dx-t').value.trim();
            if (!diag) { toast('Enter diagnosis', 'err'); return; }
            const pid = document.getElementById('dx-p').value;
            const pat = DB.patients.find(p => p.id === pid);
            const row = {
                id: 'DX-' + Date.now(),
                patient_id: pid || null, patient_name: pat?.name || 'Unlinked',
                doctor: document.getElementById('dx-doc').value,
                diagnosis: diag,
                meds: document.getElementById('dx-m').value,
                labs: document.getElementById('dx-l').value,
                date: new Date().toISOString()
            };
            if (!await ins('cm_diagnoses', row)) return;
            DB.diagnoses.unshift(row);
            renderDiagnoses();
            toast('Diagnosis saved', 'ok');
        }

        async function saveReport() {
            const txt = document.getElementById('rt').textContent;
            const pid = document.getElementById('dx-p').value;
            const pat = DB.patients.find(p => p.id === pid);
            const row = {
                id: 'DX-' + Date.now(),
                type: 'AI Report', report: txt,
                patient_id: pid || null,
                patient_name: pat?.name || 'See report',
                date: new Date().toISOString()
            };
            if (!await ins('cm_diagnoses', row)) return;
            DB.diagnoses.unshift(row);
            renderDiagnoses();
            toast('Report saved', 'ok');
        }

        function printReport() {
            const txt = document.getElementById('rt').textContent;
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Medical Report — ClinicMaster</title>
    <style>body{font-family:Georgia,serif;max-width:820px;margin:60px auto;padding:40px;color:#111;line-height:1.85;}
    h1{font-size:20px;border-bottom:1px solid #ddd;padding-bottom:10px;margin-bottom:20px;}</style>
    </head><body><h1>ClinicMaster — Medical Report</h1>
    <pre style="white-space:pre-wrap;font-family:Georgia;font-size:13px">${txt}</pre></body></html>`);
            w.print();
        }

        async function delDx(id) {
            if (!confirm('Delete this diagnosis?')) return;
            await del('cm_diagnoses', id);
            DB.diagnoses = DB.diagnoses.filter(d => d.id !== id);
            renderDiagnoses();
            toast('Diagnosis deleted');
        }

        loadPage();
    </script>
</body>

</html>